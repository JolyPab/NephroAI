<div class="chat-shell">
  <app-glass-card [extraClass]="'chat-frame glass-strong'">
    <header class="chat-header">
      <div>
        <h3 class="title">{{ titleKey | translate }}</h3>
        <p class="subtitle">{{ subtitleKey | translate: subtitleParams }}</p>
      </div>
      <div class="chip-secure">
        <i class="bi bi-shield-check"></i>
        <span>{{ secureKey | translate }}</span>
      </div>
    </header>

    <section #chatWindow class="chat-window" *ngIf="history.length || isLoading; else emptyState">
      <div class="message" *ngFor="let message of history; let i = index">
        <div class="bubble bubble-user">
          <div class="bubble-meta">
            <div class="avatar"><i class="bi bi-person"></i></div>
            <div>
              <span class="who">{{ youKey | translate }}</span>
              <span class="time">{{ message.timestamp | date: 'd MMM HH:mm' }}</span>
            </div>
          </div>
          <div class="bubble-text" [innerHTML]="renderMessageAsHtml(message.question)"></div>
        </div>

        <div
          class="bubble bubble-ai"
          *ngIf="
            ((displayedAnswers[i] !== undefined ? displayedAnswers[i] : message.answer) || '').trim().length > 0
          "
        >
          <div class="bubble-meta">
            <div class="avatar avatar-ai"><i class="bi bi-stars"></i></div>
            <div>
              <span class="who">{{ aiKey | translate }}</span>
              <span class="time">{{ message.timestamp | date: 'd MMM HH:mm' }}</span>
            </div>
          </div>
          <div
            class="bubble-text"
            [innerHTML]="renderMessageAsHtml(displayedAnswers[i] !== undefined ? displayedAnswers[i] : message.answer)"
          ></div>

          <p class="disclaimer" *ngIf="message.disclaimer">
            {{ disclaimerKey | translate }}
          </p>
        </div>
      </div>

      <div class="message" *ngIf="isLoading">
        <div class="bubble bubble-ai bubble-thinking">
          <div class="bubble-meta">
            <div class="avatar avatar-ai"><i class="bi bi-stars"></i></div>
            <div>
              <span class="who">{{ aiKey | translate }}</span>
              <span class="time">{{ thinkingKey | translate }}</span>
            </div>
          </div>
          <div class="thinking-dots" aria-hidden="true">
            <span></span><span></span><span></span>
          </div>
        </div>
      </div>
    </section>

    <ng-template #emptyState>
      <div class="empty-state">
        <i class="bi bi-robot"></i>
        <p>{{ emptyKey | translate }}</p>
      </div>
    </ng-template>

    <form class="composer" [formGroup]="form" (ngSubmit)="onSubmit()">
      <div class="composer-bar">
        <textarea
          class="chat-textarea"
          rows="2"
          formControlName="question"
          [placeholder]="placeholderKey | translate"
        ></textarea>
        <button type="submit" class="send-btn" [disabled]="isLoading || form.invalid">
          <span *ngIf="isLoading" class="loader-dot"></span>
          <span *ngIf="!isLoading" class="bi bi-send"></span>
        </button>
      </div>

      <div class="composer-foot">
        <span class="hint" *ngIf="questionControl?.invalid && questionControl?.touched">
          {{ minCharsKey | translate }}
        </span>
        <div class="quick-prompts" *ngIf="quickPrompts.length">
          <button type="button" class="prompt" *ngFor="let prompt of quickPrompts" (click)="onPrompt(prompt)">
            {{ prompt }}
          </button>
        </div>
      </div>
    </form>
  </app-glass-card>
</div>
