<app-glass-card [extraClass]="'glass-strong space-y-5'">
  <div class="flex items-center justify-between gap-3 flex-wrap">
    <h2 class="text-xl font-semibold text-[var(--text)]">{{ 'profile.title' | translate }}</h2>
    <span class="badge-glass badge-accent" *ngIf="user()">{{ user()?.role === 'PATIENT' ? ('auth.patient' | translate) : ('auth.doctor' | translate) }}</span>
  </div>

  <div *ngIf="user(); else guest" class="space-y-5">
    <dl class="profile-grid">
      <div>
        <dt>Email</dt>
        <dd>{{ user()?.email }}</dd>
      </div>
      <div>
        <dt>{{ 'profile.role' | translate }}</dt>
        <dd>{{ user()?.role === 'PATIENT' ? ('auth.patient' | translate) : ('auth.doctor' | translate) }}</dd>
      </div>
      <div>
        <dt>{{ 'profile.registered' | translate }}</dt>
        <dd>{{ user()?.created_at | date: 'd MMMM yyyy, HH:mm' }}</dd>
      </div>
    </dl>

    <app-glass-card [extraClass]="'glass-strong space-y-3'">
      <div>
        <h3 class="text-lg font-semibold text-[var(--text)]">{{ 'profile.nameTitle' | translate }}</h3>
        <p class="text-sm text-[var(--text-dim)]">{{ 'profile.nameSubtitle' | translate }}</p>
      </div>
      <form class="name-form" [formGroup]="nameForm" (ngSubmit)="saveName()">
        <app-glass-input [label]="'profile.fullName' | translate" formControlName="full_name" placeholder="Jane Doe"></app-glass-input>
        <div class="name-form__actions">
          <button type="submit" appGlassButton [disabled]="savingName">
            <span *ngIf="savingName" class="loader-dot"></span>
            <span>{{ 'profile.saveName' | translate }}</span>
          </button>
          <span class="text-xs text-[var(--text-dim)]" *ngIf="nameMessage && !nameError">{{ nameMessage | translate }}</span>
          <span class="text-xs text-[var(--danger)]" *ngIf="nameError">{{ nameError }}</span>
        </div>
      </form>
    </app-glass-card>

    <app-glass-card [extraClass]="'glass-strong space-y-3'">
      <div class="flex items-center justify-between gap-2 flex-wrap">
        <div>
          <h3 class="text-lg font-semibold text-[var(--text)]">{{ 'share.title' | translate }}</h3>
          <p class="text-sm text-[var(--text-dim)]">{{ 'share.doctorEmail' | translate }}</p>
        </div>
        <a routerLink="/patient/share" appGlassButton>{{ 'share.grant' | translate }}</a>
      </div>
      <p class="text-sm text-[var(--text-dim)]">{{ 'share.noGrants' | translate }}</p>
    </app-glass-card>

    <app-glass-card [extraClass]="'glass-strong space-y-3'">
      <div>
        <h3 class="text-lg font-semibold text-[var(--text)]">{{ documentsHeading() }}</h3>
        <p class="text-sm text-[var(--text-dim)]">{{ documentsSubtitle() }}</p>
      </div>

      <div class="documents-state" *ngIf="documentsLoading">
        <span class="loader-dot"></span>
        <span class="text-sm text-[var(--text-dim)]">{{ currentLang === 'es' ? 'Cargando documentos...' : 'Loading documents...' }}</span>
      </div>

      <div class="text-sm text-[var(--danger)]" *ngIf="documentsError">{{ documentsError }}</div>
      <div class="text-sm text-[var(--text-dim)]" *ngIf="documentsMessage && !documentsError">{{ documentsMessage }}</div>

      <div class="documents-list scrollable" *ngIf="!documentsLoading && documents.length; else noDocuments">
        <div class="documents-row glass glass-soft" *ngFor="let document of documents">
          <div class="documents-row__meta">
            <p class="documents-row__title">{{ documentName(document) }}</p>
            <p class="documents-row__info">
              {{ documentDate(document) | date: 'd MMM yyyy' }} · {{ document.num_metrics }} {{ currentLang === 'es' ? 'métricas' : 'metrics' }}
            </p>
          </div>
          <button
            type="button"
            class="documents-row__delete"
            [disabled]="deletingDocumentId === document.id"
            (click)="deleteDocument(document)"
          >
            {{ deletingDocumentId === document.id ? (currentLang === 'es' ? 'Eliminando...' : 'Deleting...') : (currentLang === 'es' ? 'Eliminar' : 'Delete') }}
          </button>
        </div>
      </div>

      <ng-template #noDocuments>
        <p class="text-sm text-[var(--text-dim)]">
          {{ currentLang === 'es' ? 'Aún no has cargado documentos.' : 'No documents uploaded yet.' }}
        </p>
      </ng-template>
    </app-glass-card>

    <div class="preferences space-y-4">
      <div class="preferences__header">
        <h3 class="text-lg font-semibold text-[var(--text)]">{{ 'PATIENT.PROFILE.PREFERENCES_TITLE' | translate }}</h3>
        <p class="text-sm text-[var(--text-dim)]">{{ 'PATIENT.PROFILE.PREFERENCES_SUBTITLE' | translate }}</p>
      </div>

      <div class="theme-toggle glass glass-strong">
        <div class="theme-toggle__text">
          <h3>{{ 'profile.themeTitle' | translate }}</h3>
          <p>{{ 'profile.themeText' | translate }}</p>
        </div>
        <div class="theme-toggle__controls">
          <button
            type="button"
            appGlassButton
            class="theme-toggle__button"
            (click)="toggleTheme()"
            [attr.aria-label]="theme() === 'dark' ? ('profile.themeLight' | translate) : ('profile.themeDark' | translate)"
          >
            <span class="material-symbols-rounded">
              {{ theme() === 'dark' ? 'light_mode' : 'dark_mode' }}
            </span>
            <span>{{ theme() === 'dark' ? ('profile.themeLight' | translate) : ('profile.themeDark' | translate) }}</span>
          </button>
        </div>
      </div>

      <div class="theme-toggle glass glass-strong">
        <div class="theme-toggle__text">
          <h3>{{ 'PATIENT.PROFILE.LANGUAGE_TITLE' | translate }}</h3>
          <p>{{ 'PATIENT.PROFILE.LANGUAGE_TEXT' | translate }}</p>
        </div>
        <div class="theme-toggle__controls">
          <div class="theme-toggle__chips">
            <button
              type="button"
              appGlassButton
              class="theme-chip"
              [class.active]="currentLang === 'es'"
              (click)="setLanguage('es')"
            >
              ES
            </button>
            <button
              type="button"
              appGlassButton
              class="theme-chip"
              [class.active]="currentLang === 'en'"
              (click)="setLanguage('en')"
            >
              EN
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <ng-template #guest>
    <p class="text-sm text-[var(--text-dim)]">Sign in to view your profile and adjust theme.</p>
    <p class="text-sm text-[var(--text-dim)]">{{ 'profile.signInToView' | translate }}</p>
  </ng-template>
</app-glass-card>
