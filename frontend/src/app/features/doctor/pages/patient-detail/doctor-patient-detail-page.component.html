<div class="space-y-6">
  <div class="doctor-tabs">
    <a
      appGlassButton
      [routerLink]="['/doctor/patient', patientId]"
      routerLinkActive="is-active"
      [routerLinkActiveOptions]="{ exact: true }"
      >{{ 'DOCTOR.CHARTS_TAB' | translate }}</a
    >
    <a
      appGlassButton
      [routerLink]="['/doctor/patient', patientId, 'assistant']"
      routerLinkActive="is-active"
      >{{ 'DOCTOR.ASSISTANT_TAB' | translate }}</a
    >
  </div>

  <app-glass-card [extraClass]="'glass-strong space-y-5'">
    <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
      <div>
        <h2 class="text-2xl font-semibold text-[var(--text)]">{{ patientName || (('doctor.detailTitle' | translate) + ' ' + patientId) }}</h2>
        <p class="text-sm text-[var(--text-dim)]">{{ 'doctor.detailSubtitle' | translate }}</p>
        <p class="text-xs text-[var(--text-dim)]" *ngIf="patientName">{{ 'doctor.detailId' | translate }} {{ patientId }}</p>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <span class="text-xs uppercase tracking-[0.2em] text-[var(--text-dim)]">{{ 'doctor.metric' | translate }}</span>
      </div>
    </div>

    <app-v2-metric-selector
      [items]="analytes"
      [selectedKey]="selectedMetric"
      [lang]="language"
      [showNumericTextToggles]="true"
      (select)="onMetricSelect($event)"
    ></app-v2-metric-selector>

    <div *ngIf="loading" class="flex flex-col items-center justify-center gap-3 py-10 text-[var(--text-dim)]">
      <div class="animate-spin h-10 w-10 border-2 border-[var(--accent)] border-t-transparent rounded-full"></div>
      {{ 'doctor.loading' | translate }}
    </div>

    <div *ngIf="!loading && !errorMessage" class="glass glass-soft p-3 text-xs text-[var(--text-dim)]">
      {{ selectedMetric ? (getAnalyteLabel(selectedMetric) + ' (' + selectedMetric + ')') : '' }}
    </div>

    <div *ngIf="!loading && errorMessage" class="glass glass-strong text-[var(--danger)] p-4">
      {{ errorMessage }}
    </div>

    <app-v2-series-page
      *ngIf="!loading && !errorMessage && selectedMetric"
      [embedded]="true"
      [analyteKeyInput]="selectedMetric"
      [doctorPatientId]="patientId"
      (pointSelected)="onSeriesPointSelected($event)"
    ></app-v2-series-page>

    <div class="note-island glass glass-soft" *ngIf="!loading && !errorMessage">
      <div>
        <h3 class="text-base font-semibold text-[var(--text)]">Doctor note for selected point</h3>
        <p class="text-xs text-[var(--text-dim)]" *ngIf="selectedSeriesPoint; else noPointSelected">
          {{ selectedMetric }} â€¢ {{ selectedPointDateLabel }}
        </p>
        <ng-template #noPointSelected>
          <p class="text-xs text-[var(--text-dim)]">Select a point in the chart to write or edit note.</p>
        </ng-template>
      </div>

      <textarea
        class="input-glass"
        rows="3"
        placeholder="Write note for this point"
        [(ngModel)]="pointNoteText"
        [disabled]="!selectedSeriesPoint || noteSaving || notesLoading"
      ></textarea>

      <div class="note-island__actions">
        <button
          type="button"
          appGlassButton
          [glassBlock]="true"
          (click)="savePointNote()"
          [disabled]="!canSaveContext || noteSaving || !pointNoteText.trim()"
        >
          {{ noteSaving ? 'Saving...' : 'Save note' }}
        </button>
        <span class="text-xs text-[var(--text-dim)]" *ngIf="!canSaveContext">Select a patient point first.</span>
        <span class="text-xs text-[var(--text-dim)]" *ngIf="notesLoading">Loading notes...</span>
        <span class="text-xs text-[var(--success)]" *ngIf="noteSaved">{{ noteSaved }}</span>
        <span class="text-xs text-[var(--danger)]" *ngIf="noteError">{{ noteError }}</span>
      </div>
    </div>
  </app-glass-card>
</div>
